const rawHideoutData = `
Air Filtering Unit,1,5 Gas mask air filter*,5 Military power filter,10 Military corrugated tube
Bitcoin Farm,1,10 T-Shaped plug,2 VPX Flash Storage Module,15 Power cord,10 Power supply unit*,15 CPU fan
Bitcoin Farm,2,15 CPU fan,10 Power supply unit,15 Printed circuit board*,10 Phase control relay,5 Military power filter
Bitcoin Farm,3,25 CPU fan*,15 Silicone tube,10 Electric motor,10 Pressure gauge,2 6-STEN-140-M military battery
Booze Generator,1,5 Metal spare parts,2 Pressure gauge*,5 Radiator helix,10 Silicone tube,1 Pipe grip wrench*,2 Analog thermometer*,10 Corrugated hose
Cultist Circle,1,1 PAID AntiRoach spray,5 Light bulb*,3 Can of white salt,1 SurvL Survivor Lighter,1 Construction measuring tape,1 WI-FI Camera
Defective Wall,1,1 Fleece fabric
Defective Wall,2,1 Fleece fabric
Defective Wall,3,1 Fierce Blow sledgehammer*,1 Fleece fabric
Defective Wall,4,1 Metal cutting scissors*,1 Toolset*,1 Fleece fabric
Defective Wall,5,2 Corrugated hose,1 Duct tape,1 Toolset*,1 Pliers Elite*,5 Metal spare parts,1 Xenomorph sealing foam,2 Bundle of wires,2 Light bulb
Gear Rack,1,1 Electric drill*,1 Sewing kit*,1 Awl*,1 Leatherman Multitool,15 Bolts,10 Fleece fabric,8 Energy-saving lamp
Gear Rack,2,1 Electric drill*,5 Duct tape,5 Shustrilo sealing foam,8 Pack of nails,12 Energy-saving lamp,10 Aramid fiber fabric,1 Wrench*
Gear Rack,3,1 Body armor repair kit*,10 Cordura polyamide fabric,15 Metal spare parts,10 KEKTAPE duct tape,15 Energy-saving lamp,1 Set of files "Master"*,1 Ratchet wrench*
Generator,1,1 Spark plug
Generator,2,1 Bulbex cable cutter*,10 Phase control relay,1 Electric motor*,15 Bundle of wires
Generator,3,5 Power supply unit*,12 Phase control relay,3 Electric motor*,16 Spark plug,10 Metal spare parts
Gym,1,5 Insulating tape,1 Metal cutting scissors*,1 WD-40 (100ml),1 Toolset*,5 Screw nuts,1 Electric drill*,5 Bolts
Hall Of Fame,1,5 Insulating tape,5 Pack of nails,5 Light bulb,1 Cat figurine*,5 Fleece fabric,1 Round pliers*
Hall Of Fame,2,1 Tech manual*,1 Pliers Elite*,1 Toolset*,1 Golden rooster figurine*,10 Energy-saving lamp,6 Pack of screws,3 Duct tape,5 Xenomorph sealing foam,2 Tube of Poxeram cold welding
Hall Of Fame,3,1 Set of files "Master"*,1 Electric drill*,1 Bronze lion figurine*,15 Energy-saving lamp,3 KEKTAPE duct tape*,6 T-Shaped plug,15 Metal spare parts,5 Power cord
Heating,1,2 Classic matches
Heating,2,5 Dry fuel,2 Hunting matches*,5 Crickent lighter
Heating,3,2 Military corrugated tube*,10 Radiator helix,10 Bundle of wires,4 Phase control relay*
Illumination,1,1 Crickent lighter
Illumination,2,14 Light bulb,10 Bundle of wires
Illumination,3,12 Energy-saving lamp,7 Capacitors*,12 Bundle of wires
Intelligence Center,1,1 Power cord,1 Intelligence folder,1 Topographic survey maps,1 Factory plan map,1 Working LCD
Intelligence Center,2,3 Intelligence folder*,3 Secure Flash drive,7 Power cord,8 Damaged hard drive
Intelligence Center,3,8 Military cable,2 Military COFDM Wireless Signal Transmitter*,1 Far-forward GPS Signal Amplifier Unit,2 VPX Flash Storage Module,8 Military flash drive,2 Secure magnetic tape cassette
Lavatory,1,1 Toilet paper,1 Toothpaste,1 Soap,1 Awl
Lavatory,2,3 KEKTAPE duct tape*,6 Corrugated hose,6 Pack of screws,1 Electric drill*,2 Sewing kit*
Lavatory,3,6 Xenomorph sealing foam,10 Corrugated hose,2 Pressure gauge*,1 Toolset*
Library,1,1 BakeEzy cook book*,5 Slim diary,5 Diary,8 Tech manual,2 Chainlet*,1 Horse figurine*
Medstation,1,1 Disposable syringe,1 Pile of meds,2 Aseptic bandage,1 Bottle of OLOLO Multivitamins
Medstation,2,6 Bottle of saline solution,3 Medical tools*,2 Medical bloodset*,10 Esmarch tourniquet
Medstation,3,1 Ophthalmoscope*,10 Bottle of saline solution,1 LEDX Skin Transilluminator
Nutrition Unit,1,1 Can of white salt,1 Power cord,2 Phase control relay
Nutrition Unit,2,2 Alkaline cleaner for heat exchangers*,4 Wrench,4 Corrugated hose,3 Phase control relay
Nutrition Unit,3,5 Can of Majaica coffee beans,5 Pack of sodium bicarbonate,2 Smoked Chimney drain cleaner*
Rest Space,1,1 Classic matches,1 Duct tape
Rest Space,2,1 Magnet*,1 DVD drive*,5 Energy-saving lamp
Rest Space,3,4 GreenBat lithium battery*,10 Bundle of wires,5 Capacitors,5 Power cord
Scav Case,1,1 Golden rooster figurine*,1 Lucky Scav Junk box,3 Bottle of Fierce Hatchling moonshine*,4 Roler Submariner gold wrist watch*,8 Golden neck chain*,6 Gold skull ring*,3 Bronze lion figurine*
Security,1,1 Construction measuring tape
Security,2,2 WD-40 (100ml),1 Pliers Elite*,2 TP-200 TNT brick
Security,3,8 NIXXOR lens,2 Working LCD*,10 Bundle of wires,1 SSD drive*
Shooting Range,1,1 Metal spare parts,1 Bolts,1 Screw nuts
Shooting Range,2,3 Electric motor*,1 Construction measuring tape*,3 Tube of Poxeram cold welding,1 Toolset*,3 Pack of screws,1 Electric drill*,8 Metal spare parts,3 WI-FI Camera,6 Bundle of wires,6 Energy-saving lamp
Shooting Range,3,1 Set of files "Master"*,5 Printed circuit board,10 Bundle of wires,5 Metal spare parts,5 Capacitors,5 Phase control relay,5 Power cord,1 Leatherman Multitool,1 Tech manual*
Solar Power,1,6 Phased array element,1 Advanced current converter,3 Working LCD*,10 Military cable,10 Military power filter
Vents,1,25000 Roubles
Vents,2,5 Metal spare parts,5 CPU fan,1 Car battery*,1 Electric motor*
Vents,3,5 Printed circuit board,4 Electric motor*,10 Metal spare parts,14 Bundle of wires,4 Car battery*
Water Collector,1,3 Duct tape,5 Screw nuts,5 Bolts,4 Corrugated hose
Water Collector,2,2 Toolset*,6 Corrugated hose,2 Electric motor*,5 KEKTAPE duct tape
Water Collector,3,1 Ratchet wrench*,2 Pliers Elite*,10 Shustrilo sealing foam
Weapon Rack,1,5 Pack of nails,5 Energy-saving lamp,5 Insulating tape,1 Hand drill*,15 Bolts,1 Metal cutting scissors*,5 Xenomorph sealing foam
Weapon Rack,2,10 Metal spare parts,10 Pack of screws,1 Electric drill*,10 Bundle of wires,1 Set of files "Master"*,3 Tube of Poxeram cold welding,10 Energy-saving lamp,10 Duct tape,5 Weapon parts
Weapon Rack,3,1 Electric drill*,15 Energy-saving lamp,10 Metal spare parts,5 KEKTAPE duct tape*,15 Bundle of wires,5 Shustrilo sealing foam,1 Tech manual*,1 #FireKlean gun lube*
Workbench,1,2 Screw nuts,2 Bolts,1 Leatherman Multitool
Workbench,2,10 Bolts,3 Toolset*,1 Set of files "Master"*,2 Electric drill*,3 Weapon parts
Workbench,3,5 Can of thermite,2 Pliers Elite*,1 #FireKlean gun lube*
`;

const modulesDb = {};
let savedProgress = {};

// Aggregated items state
const aggregatedItems = {};

try {
    const loaded = localStorage.getItem('tarkovDrawerProgress');
    if (loaded) {
        savedProgress = JSON.parse(loaded);
    }
} catch (e) {
    console.warn("Could not load local storage", e);
}

function getProgressKey(module, level, itemName) {
    return `${module}|${level}|${itemName}`;
}

function parseDatabase() {
    const lines = rawHideoutData.trim().split('\n');

    for (const line of lines) {
        if (!line.trim()) continue;
        const parts = line.split(',');
        const moduleName = parts[0].trim();
        const moduleLevel = parts[1].trim();

        if (!modulesDb[moduleName]) {
            modulesDb[moduleName] = {};
        }
        if (!modulesDb[moduleName][moduleLevel]) {
            modulesDb[moduleName][moduleLevel] = [];
        }

        for (let i = 2; i < parts.length; i++) {
            const itemStr = parts[i].trim();
            if (!itemStr) continue;

            const match = itemStr.match(/^(\d+)\s+(.+?)(\*?)$/);
            let qty = 0;
            let name = itemStr;
            let fir = false;

            if (match) {
                qty = parseInt(match[1], 10) || 0;
                name = match[2];
                fir = match[3] === '*';
            }

            modulesDb[moduleName][moduleLevel].push({
                qty: qty ? qty.toString() : "",
                name: name,
                fir: fir
            });

            // Aggregate items
            if (!aggregatedItems[name]) {
                aggregatedItems[name] = { total: 0, firTotal: 0 };
            }

            aggregatedItems[name].total += qty;
            if (fir) {
                aggregatedItems[name].firTotal += qty;
            }
        }
    }
}

let searchTerm = "";
const domContainer = document.getElementById('accordionContainer');

function highlightText(text, term) {
    if (!term) return text;
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function renderAccordions() {
    domContainer.innerHTML = '';
    const sortedModules = Object.keys(modulesDb).sort();

    sortedModules.forEach(moduleName => {
        let moduleMatchesSearch = moduleName.toLowerCase().includes(searchTerm);
        let hasItemMatch = false;

        const levelsHtmlArr = [];
        const sortedLevels = Object.keys(modulesDb[moduleName]).sort((a, b) => parseInt(a) - parseInt(b));

        sortedLevels.forEach(level => {
            const items = modulesDb[moduleName][level];
            let levelHasMatch = false;
            let itemsHtml = '';

            items.forEach(item => {
                const itemMatchesSearch = searchTerm && item.name.toLowerCase().includes(searchTerm);
                if (itemMatchesSearch) {
                    hasItemMatch = true;
                    levelHasMatch = true;
                }

                const shouldShowItem = !searchTerm || moduleMatchesSearch || itemMatchesSearch;

                if (shouldShowItem) {
                    const pKey = getProgressKey(moduleName, level, item.name);
                    const isChecked = savedProgress[pKey] ? 'checked' : '';

                    const dispQty = item.qty ? `<span class="item-qty">${item.qty}</span>` : '';
                    const dispName = highlightText(item.name, searchTerm);
                    const dispFir = item.fir ? `<span class="item-fir">FIR</span>` : '';

                    itemsHtml += `
                        <label class="item-checkbox">
                            <input type="checkbox" data-pkey="${pKey}" ${isChecked}>
                            <div class="item-details">
                                <div class="item-name">${dispQty} ${dispName} ${dispFir}</div>
                            </div>
                        </label>
                    `;
                }
            });

            if (itemsHtml) {
                levelsHtmlArr.push(`
                    <div class="level-group">
                        <h4 class="level-title">Level ${level}</h4>
                        <div class="items-list">
                            ${itemsHtml}
                        </div>
                    </div>
                `);
            }
        });

        if (!searchTerm || moduleMatchesSearch || hasItemMatch) {
            const isDrawerOpen = searchTerm !== "" || false;

            const drawerHtml = document.createElement('div');
            drawerHtml.className = `drawer ${isDrawerOpen ? 'open' : ''}`;
            drawerHtml.innerHTML = `
                <button class="drawer-header">
                    <span>${highlightText(moduleName, searchTerm)}</span>
                    <svg class="chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="drawer-body">
                    ${levelsHtmlArr.join('')}
                </div>
            `;

            const headerBtn = drawerHtml.querySelector('.drawer-header');
            headerBtn.addEventListener('click', () => {
                drawerHtml.classList.toggle('open');
            });

            domContainer.appendChild(drawerHtml);
        }
    });

    const checkboxes = domContainer.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
            const pkey = e.target.getAttribute('data-pkey');
            if (e.target.checked) {
                savedProgress[pkey] = true;
            } else {
                delete savedProgress[pkey];
            }
            localStorage.setItem('tarkovDrawerProgress', JSON.stringify(savedProgress));
        });
    });
}

// -----------------------------------------------------
// COMPLETE AGGREGATED LIST (LEFT SIDEBAR)
// -----------------------------------------------------
function initCompleteListSidebar() {
    const btnOpen = document.getElementById('openCompleteListBtn');
    const btnClose = document.getElementById('closeSidebarBtn');
    const searchInput = document.getElementById('sidebarSearch');
    const listBody = document.getElementById('sidebarList');
    const statsSpan = document.getElementById('sidebarTotalUnique');

    let sidebarSearchTerm = "";

    function toggleSidebar() {
        document.body.classList.toggle('sidebar-open');
    }

    btnOpen.addEventListener('click', toggleSidebar);
    btnClose.addEventListener('click', toggleSidebar);

    function renderSidebarList() {
        listBody.innerHTML = '';
        const keys = Object.keys(aggregatedItems).sort();

        let uniqueCount = 0;

        keys.forEach(itemName => {
            if (sidebarSearchTerm && !itemName.toLowerCase().includes(sidebarSearchTerm)) {
                return;
            }

            const data = aggregatedItems[itemName];
            // If total is 0, it means it's tracked without a quantity (e.g. 25000 Roubles)
            const dispTotal = data.total > 0 ? data.total : 'N/A';
            const dispFir = data.firTotal > 0 ? data.firTotal : '0';

            const card = document.createElement('div');
            card.className = 'aggregated-item';

            let htmlStr = `
                <div class="agg-header">
                    <span class="agg-name">${highlightText(itemName, sidebarSearchTerm)}</span>
                </div>
                <div class="agg-totals">
            `;

            if (data.total > 0) {
                htmlStr += `
                    <div class="agg-total-line">
                        <span class="lbl">Total Required:</span>
                        <span class="val">x${dispTotal}</span>
                    </div>
                `;
            }

            if (data.firTotal > 0) {
                htmlStr += `
                    <div class="agg-total-line fir">
                        <span class="lbl">Must be Found In Raid:</span>
                        <span class="val">x${dispFir}</span>
                    </div>
                `;
            }

            htmlStr += `</div>`;
            card.innerHTML = htmlStr;

            listBody.appendChild(card);
            uniqueCount++;
        });

        statsSpan.textContent = `${uniqueCount} Unique Items found`;
    }

    searchInput.addEventListener('input', (e) => {
        sidebarSearchTerm = e.target.value.toLowerCase().trim();
        renderSidebarList();
    });

    // Render it once at setup
    renderSidebarList();
}


// -----------------------------------------------------
// ITEM LOCATOR SCRAPING & TARKOV.DEV API
// -----------------------------------------------------

function initItemLocator() {
    const fab = document.getElementById('openLocatorBtn');
    const panel = document.getElementById('locatorPanel');
    const overlay = document.getElementById('locatorOverlay');
    const closeBtn = document.getElementById('closeLocatorBtn');
    const searchBtn = document.getElementById('locatorSearchBtn');
    const input = document.getElementById('locatorInput');
    const resultsDiv = document.getElementById('locatorResults');
    const loading = document.getElementById('locatorLoading');

    let isSearching = false;

    function openPanel() {
        panel.classList.add('open');
        overlay.classList.add('open');
        input.focus();
    }

    function closePanel() {
        panel.classList.remove('open');
        overlay.classList.remove('open');
    }

    fab.addEventListener('click', openPanel);
    closeBtn.addEventListener('click', closePanel);
    overlay.addEventListener('click', closePanel);

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            performLocateQuery();
        }
    });

    searchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        performLocateQuery();
    });

    async function performLocateQuery() {
        if (isSearching) return;
        const queryText = input.value.trim();
        if (!queryText) return;

        isSearching = true;
        resultsDiv.innerHTML = '';
        loading.style.display = 'block';

        const gqlQuery = `
        {
          items(name: "${queryText}") {
            name
            shortName
            wikiLink
            iconLink
            sellFor {
              price
              vendor { name }
            }
          }
        }`;

        try {
            const apiRes = await fetch('https://api.tarkov.dev/graphql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ query: gqlQuery })
            });
            const data = await apiRes.json();

            if (!data || !data.data || !data.data.items || data.data.items.length === 0) {
                resultsDiv.innerHTML = '<div class="api-no-result">No exact match found. Check spelling (e.g., "Intelligence folder").</div>';
                isSearching = false;
                loading.style.display = 'none';
                return;
            }

            const item = data.data.items[0];

            let priceHtml = '';
            if (item.sellFor && item.sellFor.length > 0) {
                const sorted = item.sellFor.sort((a, b) => b.price - a.price);
                const best = sorted[0];
                priceHtml = `
                    <div class="api-meta-section">
                        <div class="api-meta-title">Est. Value (${best.vendor.name})</div>
                        <div class="api-price">â‚½ ${best.price.toLocaleString()}</div>
                    </div>
                `;
            }

            let wikiLocationsHtml = "<ul class='wiki-spawn-list'><li>Loading actual spawn locations...</li></ul>";

            const card = document.createElement('div');
            card.className = 'api-card';
            card.innerHTML = `
                <div class="api-card-header">
                    <img src="${item.iconLink || ''}" class="api-icon" alt="${item.shortName}" onerror="this.style.display='none'">
                    <div>
                        <div class="api-title">${item.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">Data provided by Tarkov.dev</div>
                    </div>
                </div>
                ${priceHtml}
                <div class="api-meta-section">
                    <div class="api-meta-title">Where to Find (From Official Wiki)</div>
                    <div id="wikiSpawnContainer" class="wiki-spawns">
                        ${wikiLocationsHtml}
                    </div>
                </div>
                
                <a href="${item.wikiLink}" target="_blank" class="api-link-btn out-link">
                    Open Official Wiki / Map Images &raquo;
                </a>
            `;

            resultsDiv.appendChild(card);

            try {
                const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(item.wikiLink);
                const proxyRes = await fetch(proxyUrl);
                const proxyData = await proxyRes.json();

                const parser = new DOMParser();
                const doc = parser.parseFromString(proxyData.contents, 'text/html');

                const locationHeadings = Array.from(doc.querySelectorAll('h2 .mw-headline, h3 .mw-headline, h4 .mw-headline')).filter(h =>
                    h.textContent.toLowerCase().includes('location') || h.textContent.toLowerCase() === 'spawn locations'
                );

                let extractedHtml = "";

                if (locationHeadings.length > 0) {
                    const headingEl = locationHeadings[0].parentElement;
                    const headingLevel = parseInt(headingEl.tagName.substring(1));

                    let node = headingEl.nextElementSibling;
                    let foundSpawns = false;

                    while (node) {
                        if (node.tagName.match(/^H[1-6]$/)) {
                            const thisLevel = parseInt(node.tagName.substring(1));
                            if (thisLevel <= headingLevel) break; // Reached a new section of equal or higher importance
                        }

                        if (node.tagName === 'UL' || node.tagName === 'P') {
                            const cleanText = node.innerHTML.replace(/\[\d+\]/g, '');
                            if (node.tagName === 'UL') {
                                extractedHtml += `<ul>${cleanText}</ul>`;
                                foundSpawns = true;
                            } else if (node.tagName === 'P' && node.textContent.trim().length > 0) {
                                extractedHtml += `<p>${cleanText}</p>`;
                                foundSpawns = true;
                            }
                        }
                        node = node.nextElementSibling;
                    }

                    if (!foundSpawns) {
                        extractedHtml = "<p>No specific typed locations found. Map images might be available on Wiki.</p>";
                    }
                } else {
                    extractedHtml = "<p>No specific location data found on the wiki. It might be crafted or unpredictable.</p>";
                }

                document.getElementById('wikiSpawnContainer').innerHTML = extractedHtml;

            } catch (wikiErr) {
                console.error("Wiki Scraping Error: ", wikiErr);
                document.getElementById('wikiSpawnContainer').innerHTML = "<p>Failed to load Live Wiki data. Please click the button below directly.</p>";
            }

            loading.style.display = 'none';
            isSearching = false;

        } catch (err) {
            console.error(err);
            loading.style.display = 'none';
            resultsDiv.innerHTML = '<div class="api-no-result">Error connecting to Tarkov.dev API.</div>';
            isSearching = false;
        }
    }
}

// -----------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
    parseDatabase();
    initCompleteListSidebar();
    renderAccordions();

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
        searchTerm = e.target.value.toLowerCase().trim();
        renderAccordions();
    });

    document.getElementById('expandAllBtn').addEventListener('click', () => {
        document.querySelectorAll('.drawer').forEach(d => d.classList.add('open'));
    });

    document.getElementById('collapseAllBtn').addEventListener('click', () => {
        document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
    });

    document.getElementById('resetProgressBtn').addEventListener('click', () => {
        if (confirm("Reset all tracked progress?")) {
            savedProgress = {};
            localStorage.removeItem('tarkovDrawerProgress');
            renderAccordions();
        }
    });

    initItemLocator();
});
